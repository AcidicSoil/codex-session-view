<!-- path: thermal-lattices.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thermal Lattices</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Lora:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --anthropic-dark: #141413;
      --anthropic-light: #faf9f5;
      --anthropic-mid-gray: #b0aea5;
      --anthropic-light-gray: #e8e6dc;
      --anthropic-orange: #d97757;
      --anthropic-blue: #6a9bcc;
      --anthropic-green: #788c5d;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--anthropic-light) 0%, #f5f3ee 100%);
      min-height: 100vh;
      color: var(--anthropic-dark);
    }

    .container {
      display: flex;
      min-height: 100vh;
      padding: 20px;
      gap: 20px;
    }

    .sidebar {
      width: 320px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(20, 20, 19, 0.1);
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar h1 {
      font-family: 'Lora', serif;
      font-size: 24px;
      font-weight: 500;
      color: var(--anthropic-dark);
      margin-bottom: 8px;
    }

    .sidebar .subtitle {
      color: var(--anthropic-mid-gray);
      font-size: 14px;
      margin-bottom: 32px;
      line-height: 1.4;
    }

    .control-section { margin-bottom: 32px; }

    .control-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--anthropic-dark);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-section h3::before {
      content: '•';
      color: var(--anthropic-orange);
      font-weight: bold;
    }

    .seed-input {
      width: 100%;
      background: var(--anthropic-light);
      padding: 12px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-bottom: 12px;
      border: 1px solid var(--anthropic-light-gray);
      text-align: center;
    }

    .seed-input:focus {
      outline: none;
      border-color: var(--anthropic-orange);
      box-shadow: 0 0 0 2px rgba(217, 119, 87, 0.1);
      background: white;
    }

    .seed-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .button {
      background: var(--anthropic-orange);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .button:hover { background: #c86641; transform: translateY(-1px); }
    .button:active { transform: translateY(0); }

    .button.secondary { background: var(--anthropic-blue); }
    .button.secondary:hover { background: #5a8bb8; }

    .button.tertiary { background: var(--anthropic-green); }
    .button.tertiary:hover { background: #6b7b52; }

    .button-row { display: flex; gap: 8px; }
    .button-row .button { flex: 1; }

    .control-group { margin-bottom: 20px; }

    .control-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--anthropic-dark);
      margin-bottom: 8px;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider-container input[type="range"] {
      flex: 1;
      height: 4px;
      background: var(--anthropic-light-gray);
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--anthropic-orange);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      background: #c86641;
    }

    .value-display {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--anthropic-mid-gray);
      min-width: 68px;
      text-align: right;
    }

    .color-group { margin-bottom: 16px; }

    .color-group label {
      display: block;
      font-size: 12px;
      color: var(--anthropic-mid-gray);
      margin-bottom: 4px;
    }

    .color-picker-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-picker-container input[type="color"] {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: none;
      padding: 0;
    }

    .color-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--anthropic-mid-gray);
    }

    .canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }

    #canvas-container {
      width: 100%;
      max-width: 1000px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(20, 20, 19, 0.1);
      background: white;
    }

    #canvas-container canvas {
      display: block;
      width: 100% !important;
      height: auto !important;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--anthropic-mid-gray);
      padding: 40px;
    }

    @media (max-width: 600px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; }
      .canvas-area { padding: 20px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <h1>Thermal Lattices</h1>
      <div class="subtitle">
        Curl-noise convection cells traced by seeded particle probes. Explore seeds and tune the system’s “thermodynamics.”
      </div>

      <div class="control-section">
        <h3>Seed</h3>
        <input type="number" id="seed-input" class="seed-input" value="12345" />
        <div class="seed-controls">
          <button class="button secondary" onclick="previousSeed()">← Prev</button>
          <button class="button secondary" onclick="nextSeed()">Next →</button>
        </div>
        <div class="button-row" style="margin-bottom: 8px;">
          <button class="button tertiary" onclick="randomSeedAndUpdate()">↻ Random</button>
          <button class="button tertiary" onclick="updateSeed()">Go</button>
        </div>
      </div>

      <div class="control-section">
        <h3>Parameters</h3>

        <div class="control-group">
          <label>Particle Count</label>
          <div class="slider-container">
            <input type="range" id="particleCount" min="2000" max="20000" step="500" value="9000"
                   oninput="updateParam('particleCount', this.value)">
            <span class="value-display" id="particleCount-value">9000</span>
          </div>
        </div>

        <div class="control-group">
          <label>Noise Scale</label>
          <div class="slider-container">
            <input type="range" id="noiseScale" min="0.001" max="0.020" step="0.001" value="0.007"
                   oninput="updateParam('noiseScale', this.value)">
            <span class="value-display" id="noiseScale-value">0.007</span>
          </div>
        </div>

        <div class="control-group">
          <label>Step Size</label>
          <div class="slider-container">
            <input type="range" id="stepSize" min="0.25" max="4.00" step="0.05" value="1.20"
                   oninput="updateParam('stepSize', this.value)">
            <span class="value-display" id="stepSize-value">1.20</span>
          </div>
        </div>

        <div class="control-group">
          <label>Trail Alpha (fade)</label>
          <div class="slider-container">
            <input type="range" id="trailAlpha" min="0" max="60" step="1" value="14"
                   oninput="updateParam('trailAlpha', this.value)">
            <span class="value-display" id="trailAlpha-value">14</span>
          </div>
        </div>

        <div class="control-group">
          <label>Flow Speed</label>
          <div class="slider-container">
            <input type="range" id="flowSpeed" min="0.00" max="2.00" step="0.05" value="0.65"
                   oninput="updateParam('flowSpeed', this.value)">
            <span class="value-display" id="flowSpeed-value">0.65</span>
          </div>
        </div>
      </div>

      <div class="control-section">
        <h3>Colors</h3>

        <div class="color-group">
          <label>Palette A (cool)</label>
          <div class="color-picker-container">
            <input type="color" id="paletteA" value="#3b6ea8" onchange="updateColor('paletteA', this.value)">
            <span class="color-value" id="paletteA-value">#3b6ea8</span>
          </div>
        </div>

        <div class="color-group">
          <label>Palette B (hot)</label>
          <div class="color-picker-container">
            <input type="color" id="paletteB" value="#d97757" onchange="updateColor('paletteB', this.value)">
            <span class="color-value" id="paletteB-value">#d97757</span>
          </div>
        </div>
      </div>

      <div class="control-section">
        <h3>Actions</h3>
        <div class="button-row" style="margin-bottom: 8px;">
          <button class="button" onclick="regenerate()">Regenerate</button>
          <button class="button" onclick="resetParameters()">Reset</button>
        </div>
        <button class="button secondary" onclick="downloadPNG()">Download PNG</button>
      </div>
    </div>

    <div class="canvas-area">
      <div id="canvas-container">
        <div class="loading">Initializing generative art...</div>
      </div>
    </div>
  </div>

  <script>
    // ──────────────────────────────────────────────────────────────────────────
    // Parameters
    // ──────────────────────────────────────────────────────────────────────────
    let params = {
      seed: 12345,
      particleCount: 9000,
      noiseScale: 0.007,
      stepSize: 1.20,
      trailAlpha: 14,
      flowSpeed: 0.65,
      paletteA: '#3b6ea8',
      paletteB: '#d97757',
    };

    const defaultParams = { ...params };

    // ──────────────────────────────────────────────────────────────────────────
    // System
    // ──────────────────────────────────────────────────────────────────────────
    let particles = [];
    let flowField = [];
    let cols = 0, rows = 0;

    // Flow field resolution in pixels (smaller => more detail, slower)
    const fieldCell = 12;

    // Deterministic time (avoid millis() for reproducibility)
    let tick = 0;

    function setup() {
      const canvas = createCanvas(1200, 1200);
      canvas.parent('canvas-container');
      pixelDensity(1);

      initializeSystem();

      const loadingEl = document.querySelector('.loading');
      if (loadingEl) loadingEl.style.display = 'none';
    }

    function initializeSystem() {
      randomSeed(params.seed);
      noiseSeed(params.seed);

      tick = 0;

      cols = floor(width / fieldCell);
      rows = floor(height / fieldCell);
      flowField = new Array(cols * rows);

      particles = [];
      for (let i = 0; i < params.particleCount; i++) particles.push(new Particle());

      background(250, 249, 245);
      generateFlowField();
    }

    function draw() {
      // fade overlay: smaller alpha => longer trails
      noStroke();
      fill(250, 249, 245, params.trailAlpha);
      rect(0, 0, width, height);

      // update flow field over time (deterministic tick)
      generateFlowField();

      for (let i = 0; i < particles.length; i++) {
        particles[i].follow(flowField);
        particles[i].update();
        particles[i].show();
      }

      tick += 1;
    }

    // ──────────────────────────────────────────────────────────────────────────
    // Field: layered curl-noise convection
    // ──────────────────────────────────────────────────────────────────────────
    function generateFlowField() {
      const t = tick * 0.01 * params.flowSpeed;

      // Two octaves: a coarse “cell” scale and a finer “microturbulence” scale
      const s1 = params.noiseScale;
      const s2 = params.noiseScale * 2.7;

      const eps = 0.003; // derivative step in noise-space

      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const nx = x * fieldCell * s1;
          const ny = y * fieldCell * s1;

          // Base potential field (layered)
          const p1 = noise(nx, ny, t);
          const p2 = noise(x * fieldCell * s2, y * fieldCell * s2, t * 1.3);
          const potential = 0.72 * p1 + 0.28 * p2;

          // Approx gradient of potential in noise-space (finite differences)
          const dx =
            (noise(nx + eps, ny, t) - noise(nx - eps, ny, t)) * 0.5 +
            0.35 * (noise(x * fieldCell * s2 + eps, y * fieldCell * s2, t * 1.3) -
                    noise(x * fieldCell * s2 - eps, y * fieldCell * s2, t * 1.3)) * 0.5;

          const dy =
            (noise(nx, ny + eps, t) - noise(nx, ny - eps, t)) * 0.5 +
            0.35 * (noise(x * fieldCell * s2, y * fieldCell * s2 + eps, t * 1.3) -
                    noise(x * fieldCell * s2, y * fieldCell * s2 - eps, t * 1.3)) * 0.5;

          // Curl-like rotation: rotate gradient by 90° to get circulation (convection feel)
          let v = createVector(dy, -dx);

          // Bias strength by how “thermally active” the cell is (centered potential)
          const act = abs(potential - 0.5);
          const strength = 0.9 + act * 2.2;

          v.mult(strength);

          // Normalize + apply step size (avoid zero vectors)
          if (v.magSq() < 1e-8) v = p5.Vector.random2D();
          v.normalize().mult(params.stepSize);

          flowField[x + y * cols] = v;
        }
      }
    }

    // ──────────────────────────────────────────────────────────────────────────
    // Particles: probes that reveal the lattice via trails
    // ──────────────────────────────────────────────────────────────────────────
    class Particle {
      constructor() {
        this.pos = createVector(random(width), random(height));
        this.prev = this.pos.copy();
        this.vel = createVector(0, 0);
        this.acc = createVector(0, 0);

        // Per-particle phase is seeded; stable per seed
        this.phase = random(1000);
        this.w = random(0.6, 1.4);
      }

      follow(field) {
        const x = floor(constrain(this.pos.x / fieldCell, 0, cols - 1));
        const y = floor(constrain(this.pos.y / fieldCell, 0, rows - 1));
        const idx = x + y * cols;
        const force = field[idx];
        if (force) this.applyForce(force);
      }

      applyForce(f) {
        this.acc.add(f);
      }

      update() {
        // Semi-inertial motion: reduce jitter, preserve flow
        this.vel.add(this.acc);
        this.vel.limit(params.stepSize * 2.1);
        this.pos.add(this.vel);
        this.acc.mult(0);

        this.wrap();
      }

      wrap() {
        let wrapped = false;

        if (this.pos.x < 0) { this.pos.x = width; wrapped = true; }
        else if (this.pos.x > width) { this.pos.x = 0; wrapped = true; }

        if (this.pos.y < 0) { this.pos.y = height; wrapped = true; }
        else if (this.pos.y > height) { this.pos.y = 0; wrapped = true; }

        if (wrapped) this.prev = this.pos.copy();
      }

      show() {
        // Sample a “temperature” from a stable noise field
        const s = params.noiseScale * 1.8;
        const temp = noise(this.pos.x * s, this.pos.y * s, this.phase * 0.001);

        const cA = color(params.paletteA);
        const cB = color(params.paletteB);
        const c = lerpColor(cA, cB, temp);

        stroke(red(c), green(c), blue(c), 90);
        strokeWeight(this.w);

        line(this.prev.x, this.prev.y, this.pos.x, this.pos.y);
        this.prev = this.pos.copy();
      }
    }

    // ──────────────────────────────────────────────────────────────────────────
    // UI
    // ──────────────────────────────────────────────────────────────────────────
    function updateParam(paramName, value) {
      const elValue = document.getElementById(paramName + '-value');
      if (elValue) elValue.textContent = value;

      // numeric parsing
      if (paramName === 'particleCount') params[paramName] = parseInt(value, 10);
      else params[paramName] = parseFloat(value);

      // regeneration policy
      if (paramName === 'particleCount') {
        initializeSystem();
        return;
      }

      // For field-defining params, reinit to keep behavior stable + deterministic
      if (paramName === 'noiseScale' || paramName === 'stepSize') {
        randomSeed(params.seed);
        noiseSeed(params.seed);
        tick = 0;
        background(250, 249, 245);
        generateFlowField();
        // particles keep their seeded initialization unless you fully reinit
        // but reinit looks cleaner after scale/step changes
        particles = [];
        for (let i = 0; i < params.particleCount; i++) particles.push(new Particle());
        return;
      }
    }

    function updateColor(colorId, value) {
      params[colorId] = value;
      const elValue = document.getElementById(colorId + '-value');
      if (elValue) elValue.textContent = value;
    }

    function updateSeedDisplay() {
      document.getElementById('seed-input').value = params.seed;
    }

    function updateSeed() {
      const input = document.getElementById('seed-input');
      const newSeed = parseInt(input.value, 10);
      if (Number.isFinite(newSeed) && newSeed > 0) {
        params.seed = newSeed;
        initializeSystem();
      } else {
        updateSeedDisplay();
      }
    }

    function previousSeed() {
      params.seed = Math.max(1, params.seed - 1);
      updateSeedDisplay();
      initializeSystem();
    }

    function nextSeed() {
      params.seed = params.seed + 1;
      updateSeedDisplay();
      initializeSystem();
    }

    function randomSeedAndUpdate() {
      params.seed = Math.floor(Math.random() * 999999) + 1;
      updateSeedDisplay();
      initializeSystem();
    }

    function regenerate() {
      // same seed + same params => identical restart
      initializeSystem();
    }

    function resetParameters() {
      params = { ...defaultParams };

      const ids = ['particleCount','noiseScale','stepSize','trailAlpha','flowSpeed'];
      for (const id of ids) {
        const input = document.getElementById(id);
        const out = document.getElementById(id + '-value');
        if (input) input.value = params[id];
        if (out) out.textContent = String(params[id]);
      }

      const palA = document.getElementById('paletteA');
      const palAv = document.getElementById('paletteA-value');
      const palB = document.getElementById('paletteB');
      const palBv = document.getElementById('paletteB-value');

      if (palA) palA.value = params.paletteA;
      if (palAv) palAv.textContent = params.paletteA;
      if (palB) palB.value = params.paletteB;
      if (palBv) palBv.textContent = params.paletteB;

      updateSeedDisplay();
      initializeSystem();
    }

    function downloadPNG() {
      saveCanvas('thermal-lattices-' + params.seed, 'png');
    }

    window.addEventListener('load', function () {
      updateSeedDisplay();

      // Initialize UI value labels
      const ids = ['particleCount','noiseScale','stepSize','trailAlpha','flowSpeed'];
      for (const id of ids) {
        const out = document.getElementById(id + '-value');
        const input = document.getElementById(id);
        if (out && input) out.textContent = input.value;
      }

      document.getElementById('paletteA-value').textContent = params.paletteA;
      document.getElementById('paletteB-value').textContent = params.paletteB;
    });
  </script>
</body>
</html>
